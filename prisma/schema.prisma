// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model Item {
  id             String    @id @default(cuid())
  userId         String    // Owner of this item
  name           String    @db.VarChar(50)
  unit           String    @db.VarChar(16) // "pcs" etc. - letters only
  totalQuantity  Int       // authoritative stock count (0-100000)
  price          Decimal?  @db.Decimal(12, 2) // default booking price per unit
  notes          String?   @db.VarChar(50)
  imageUrl       String?   @db.VarChar(500) // Cloudinary URL for item image
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookingItems   BookingItem[]

  @@unique([userId, name], name: "unique_user_item_name")
  @@index([userId])
}

model Customer {
  id        String   @id @default(cuid())
  userId    String   // Owner of this customer record
  name      String   // Will be deprecated, keeping for backward compatibility
  firstName String?  @db.VarChar(50) // Will become required after migration
  lastName  String?  @db.VarChar(50)
  phone     String?  @db.VarChar(15) // E.164 format
  email     String?  @db.VarChar(254) // RFC5322 max length
  address   String?  @db.VarChar(200)
  notes     String?  @db.VarChar(50)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings        Booking[]
  notificationOptOut CustomerNotificationOptOut?

  @@unique([userId, email], name: "unique_user_customer_email")
  @@index([userId])
}

model Booking {
  id              String        @id @default(cuid())
  userId          String        // Owner of this booking
  customerId      String
  startDate       DateTime      // store date at 00:00Z
  endDate         DateTime      // inclusive range
  status          String        @default("CONFIRMED") @db.VarChar(30) // CONFIRMED, CONFIRMED_WITHOUT_PAYMENT, OUT, RETURNED, CANCELLED
  reference       String?       @db.VarChar(12) // human-friendly code (e.g., BKG-000123)
  notes           String?       @db.VarChar(50)
  color           String?       @db.VarChar(7) // hex color for calendar display (e.g., #3b82f6)
  totalPrice      Decimal?      @db.Decimal(12, 2) // total agreed booking price
  advancePayment  Decimal?      @db.Decimal(12, 2) // initial advance payment
  paymentDueDate  DateTime?     // date when complete payment is due
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer        Customer      @relation(fields: [customerId], references: [id])
  items           BookingItem[]
  payments        Payment[]     // track all payments made

  @@index([userId])
  @@index([customerId]) // For filtering bookings by customer
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@unique([userId, reference], name: "unique_user_booking_reference")
  @@map("Rental")
}

model BookingItem {
  id        String  @id @default(cuid())
  bookingId String  @map("rentalId")
  itemId    String
  quantity  Int

  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  item      Item    @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@unique([bookingId, itemId], map: "RentalItem_rentalId_itemId_key")
  @@map("RentalItem")
}

model Payment {
  id          String   @id @default(cuid())
  bookingId   String   @map("rentalId")
  amount      Decimal  @db.Decimal(12, 2)
  paymentDate DateTime @default(now())
  notes       String?  @db.VarChar(100)
  createdAt   DateTime @default(now())

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId], map: "Payment_rentalId_idx")
  @@index([paymentDate]) // For financial reports and payment history filtering
}

model Settings {
  id                    String   @id @default(cuid())
  userId                String   @unique // Each user has their own settings
  businessName          String?  @db.VarChar(25)
  currency              String   @default("USD") @db.VarChar(3) // ISO 4217 code
  currencySymbol        String   @default("$") @db.VarChar(5)
  businessPhone         String?  @db.VarChar(15) // E.164 format
  businessEmail         String?  @db.VarChar(254)
  businessAddress       String?  @db.VarChar(100)
  taxRate               Decimal? @db.Decimal(5, 2) // percentage (e.g., 10.00 for 10%)
  lowStockThreshold     Int      @default(5)
  defaultRentalDays     Int      @default(1)
  dateFormat            String   @default("MM/DD/YYYY") @db.VarChar(20)
  timezone              String   @default("UTC") @db.VarChar(64) // IANA timezone
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Authentication & Premium Features
model User {
  id                String        @id @default(cuid())
  email             String        @unique @db.VarChar(254)
  passwordHash      String
  role              String        @default("user") @db.VarChar(20) // 'user' | 'admin'
  firstName         String?       @db.VarChar(50)
  lastName          String?       @db.VarChar(50)
  businessName      String?       @db.VarChar(100) // Personalized business name for each user
  logoUrl           String?       @db.VarChar(500) // URL to user's custom logo
  emailVerified     Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // User's own data
  items             Item[]
  customers         Customer[]
  bookings          Booking[]
  settings          Settings?

  // Premium features
  subscription           Subscription?
  publicPage             PublicPage?
  passwordResets         PasswordReset[]
  emailVerifications     EmailVerification[]
  notificationPreferences NotificationPreferences?
  notificationLogs       NotificationLog[]
  teamMembers            TeamMember[]
  teamInvitations        TeamInvitation[]
  activityLogs           ActivityLog[]

  @@index([email])
}

model Subscription {
  id                String   @id @default(cuid())
  userId            String   @unique
  plan              String   @default("free") @db.VarChar(20) // 'free' | 'pro' | 'business'
  status            String   @default("active") @db.VarChar(20) // 'active' | 'trialing' | 'past_due' | 'canceled'
  currentPeriodEnd  DateTime?
  stripeCustomerId  String?  @unique @db.VarChar(100)
  stripeSubId       String?  @unique @db.VarChar(100)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PublicPage {
  id              String   @id @default(cuid())
  userId          String   @unique
  slug            String   @unique @db.VarChar(100)
  title           String   @db.VarChar(100)
  phonePublic     String?  @db.VarChar(15)
  emailPublic     String?  @db.VarChar(254)
  itemsJson       Json     // Array of {itemId, displayName}
  isActive        Boolean  @default(true)
  contactMethods  Json?    // Array of contact methods: ['app', 'email', 'sms', 'whatsapp', 'social']
  customMessage   String?  @db.Text // Custom message/instructions for customers
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  inquiries       PublicInquiry[]

  @@index([slug])
}

model PublicInquiry {
  id              String   @id @default(cuid())
  publicPageId    String
  name            String   @db.VarChar(100)
  phone           String?  @db.VarChar(15)
  email           String?  @db.VarChar(254)
  message         String?  @db.Text
  startDate       DateTime
  endDate         DateTime
  selectedItems   Json?    // Array of {itemId, quantity, name, price}
  status          String   @default("pending") @db.VarChar(30) // 'pending' | 'confirmed_without_payment' | 'confirmed' | 'cancelled'
  denialReason    String?  @db.Text // Optional reason when status is 'cancelled'
  paymentLinkUrl  String?  @db.VarChar(500) // Payment link sent to customer
  totalAmount     Decimal? @db.Decimal(12, 2) // Total rental amount
  platformFee     Decimal? @db.Decimal(12, 2) // 1.5% platform fee
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  page            PublicPage @relation(fields: [publicPageId], references: [id], onDelete: Cascade)

  @@index([publicPageId])
  @@index([createdAt])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model PasswordReset {
  id              String   @id @default(cuid())
  userId          String
  token           String   @unique @db.VarChar(100)
  expiresAt       DateTime
  used            Boolean  @default(false)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model EmailVerification {
  id              String   @id @default(cuid())
  userId          String
  token           String   @unique @db.VarChar(100)
  used            Boolean  @default(false)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

// Events Near You - Premium Feature
model NigerianEvent {
  id                  String    @id @default(cuid())
  eventId             String    @unique @db.VarChar(100) // stable hash of title + date + location_state + source_url
  eventType           String    @db.VarChar(50) // wedding | traditional_marriage | burial | memorial | child_dedication | christening | naming | thanksgiving | anniversary | birthday | other_ceremony
  title               String    @db.VarChar(200)
  dateStart           DateTime
  dateEnd             DateTime?
  locationRaw         String?   @db.VarChar(300)
  locationState       String?   @db.VarChar(50) // Nigeria state or FCT
  locationCityLga     String?   @db.VarChar(100)
  venueName           String?   @db.VarChar(200)
  contactName         String?   @db.VarChar(100)
  contactRole         String?   @db.VarChar(100)
  contactPhone        String?   @db.VarChar(20)
  contactEmail        String?   @db.VarChar(254)
  organizerOrg        String?   @db.VarChar(200)
  organizerSocial     String?   @db.VarChar(500) // Social media URLs (Instagram/Facebook/Twitter)
  sourcePlatform      String    @db.VarChar(100) // Church Website, Eventbrite, Instagram Post, etc.
  sourceUrl           String    @db.Text
  sourcePublishedAt   DateTime?
  extractedAt         DateTime  @default(now())
  confidence          Decimal   @default(0.6) @db.Decimal(3, 2) // 0-1 confidence score
  notes               String?   @db.VarChar(500)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([eventType])
  @@index([dateStart])
  @@index([locationState])
  @@index([sourcePlatform])
  @@index([createdAt])
}

model EventSourceLog {
  id                  String   @id @default(cuid())
  runAtUtc            DateTime @default(now())
  sourcePlatform      String   @db.VarChar(100)
  sourceUrl           String?  @db.Text
  eventsAdded         Int      @default(0)
  eventsUpdated       Int      @default(0)
  eventsRemoved       Int      @default(0)
  errors              String?  @db.Text // JSON string of errors
  totalActive         Int      @default(0)
  executionTimeMs     Int?     // Time taken for this source
  createdAt           DateTime @default(now())

  @@index([sourcePlatform])
  @@index([runAtUtc])
}

// Smart Notifications & Reminders - Premium Feature
model NotificationPreferences {
  id                          String   @id @default(cuid())
  userId                      String   @unique

  // Business alerts (email & SMS for owner)
  newInquiryEmail             Boolean  @default(true)
  newInquirySms               Boolean  @default(false)
  overduePaymentEmail         Boolean  @default(true)
  overduePaymentSms           Boolean  @default(false)
  lowStockEmail               Boolean  @default(true)
  lowStockSms                 Boolean  @default(false)
  upcomingBookingEmail        Boolean  @default(true)
  upcomingBookingSms          Boolean  @default(false)
  bookingConfirmedEmail       Boolean  @default(true)
  bookingConfirmedSms         Boolean  @default(false)

  // Customer reminders (email & SMS sent to customers)
  customerRentalReminderEmail Boolean  @default(true)
  customerRentalReminderSms   Boolean  @default(false)
  customerReturnReminderEmail Boolean  @default(true)
  customerReturnReminderSms   Boolean  @default(false)
  customerPaymentReminderEmail Boolean @default(true)
  customerPaymentReminderSms  Boolean  @default(false)

  // Timing preferences (in hours before event)
  reminderHoursBefore         Int      @default(24) // hours before event to send reminder

  // SMS settings (for Twilio/Africa's Talking etc.)
  smsProviderPhone            String?  @db.VarChar(15) // Business SMS number

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  user                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Customer opt-out tracking (CAN-SPAM compliance)
model CustomerNotificationOptOut {
  id          String   @id @default(cuid())
  customerId  String
  optOutEmail Boolean  @default(false) // opted out of all email notifications
  optOutSms   Boolean  @default(false) // opted out of all SMS notifications
  optOutDate  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId])
  @@index([customerId])
}

// Notification log for tracking sent notifications
model NotificationLog {
  id              String   @id @default(cuid())
  userId          String
  customerId      String?
  bookingId       String?
  notificationType String  @db.VarChar(50) // 'new_inquiry', 'overdue_payment', 'low_stock', 'rental_reminder', etc.
  channel         String   @db.VarChar(10) // 'email' | 'sms'
  recipient       String   @db.VarChar(254) // email or phone number
  status          String   @db.VarChar(20) // 'sent' | 'failed' | 'bounced'
  errorMessage    String?  @db.Text
  sentAt          DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
  @@index([bookingId])
  @@index([notificationType])
  @@index([sentAt])
}

// Team Collaboration - Premium Feature
model TeamMember {
  id              String   @id @default(cuid())
  userId          String   // Owner of the business
  memberEmail     String   @db.VarChar(254)
  memberName      String?  @db.VarChar(100)
  role            String   @db.VarChar(20) // 'admin' | 'manager' | 'staff' | 'viewer'
  permissions     Json     // Detailed permissions object
  status          String   @default("pending") @db.VarChar(20) // 'pending' | 'active' | 'suspended'
  invitedAt       DateTime @default(now())
  acceptedAt      DateTime?
  lastActiveAt    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, memberEmail])
  @@index([userId])
  @@index([memberEmail])
  @@index([status])
}

model TeamInvitation {
  id              String   @id @default(cuid())
  userId          String   // Owner sending invitation
  email           String   @db.VarChar(254)
  token           String   @unique @db.VarChar(100)
  role            String   @db.VarChar(20)
  permissions     Json
  expiresAt       DateTime
  used            Boolean  @default(false)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([email])
}

model ActivityLog {
  id              String   @id @default(cuid())
  userId          String   // Business owner
  actorId         String?  // Team member who performed action (null if owner)
  actorEmail      String?  @db.VarChar(254)
  action          String   @db.VarChar(50) // 'created', 'updated', 'deleted'
  entity          String   @db.VarChar(50) // 'booking', 'item', 'customer', etc.
  entityId        String?
  details         Json?    // Additional context
  ipAddress       String?  @db.VarChar(45) // IPv6 max length
  userAgent       String?  @db.VarChar(500)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actorEmail])
  @@index([entity])
  @@index([createdAt])
}
// Wholesale Supplier Discovery - Premium Feature
// Helps rental businesses find wholesale suppliers for event equipment

model WholesaleSupplier {
  id                    String   @id @default(cuid())
  supplierId            String   @unique @db.VarChar(64) // stable hash of (company_name + primary_phone + state)

  // Basic Info
  companyName           String   @db.VarChar(200)
  akaNames              Json?    // Array of alternative names

  // Categories & Products
  categories            Json     // Array: seating, tables, tents, flooring_grass, linens, decor, lighting, sound, staging_truss, catering, power_generators, mobile_toilet, bridal_wear
  productExamples       Json?    // Array of specific product names

  // Wholesale Terms
  wholesaleTerms        Json?    // {bulk_available, moq_units, price_range_hint, lead_time_days, delivery_options[], returns_warranty}

  // Location
  coverageRegions       Json?    // Array: Nigeria-wide, South-West, South-East, etc.
  addressText           String?  @db.VarChar(500)
  state                 String?  @db.VarChar(50) // Normalized to 36 states + FCT
  lgaOrCity             String?  @db.VarChar(100)
  lat                   Decimal? @db.Decimal(10, 7)
  lon                   Decimal? @db.Decimal(10, 7)

  // Contact Info
  phones                Json?    // Array of E.164 formatted phones
  whatsapp              Json?    // Array of WhatsApp numbers
  emails                Json?    // Array of email addresses
  websites              Json?    // Array of website URLs
  socials               Json?    // {instagram, facebook, tiktok, others[]}
  businessHours         String?  @db.VarChar(200)

  // Ratings & Reviews
  ratings               Json?    // {google: {stars, count}, facebook: {stars, count}}

  // Verification
  verifications         Json?    // {explicit_wholesale_language: bool, evidence_snippets[], cac_number}
  confidence            Decimal  @default(0.5) @db.Decimal(3, 2) // 0.0-1.0

  // Admin & Source
  notes                 String?  @db.Text
  sourceUrl             String   @db.Text
  sourcePlatform        String   @db.VarChar(100) // maps | directory | marketplace | social | official_site
  extractedAt           DateTime @default(now())
  lastSeenAt            DateTime @default(now())

  // Admin Status
  approvalStatus        String   @default("pending") @db.VarChar(20) // pending | approved | rejected
  isBlacklisted         Boolean  @default(false)
  blacklistReason       String?  @db.VarChar(500)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  approvals             WholesaleSupplierApproval[]

  @@index([supplierId])
  @@index([state])
  @@index([approvalStatus])
  @@index([isBlacklisted])
  @@index([confidence])
  @@index([lastSeenAt])
  @@index([createdAt])
}

model WholesaleSupplierSourceLog {
  id                    String   @id @default(cuid())
  runId                 String   @db.VarChar(64) // Unique ID for each crawl run
  runAtUtc              DateTime @default(now())
  sourcePlatform        String   @db.VarChar(100)
  sourceUrl             String   @db.Text
  httpStatus            Int?
  parseSuccess          Boolean  @default(false)
  recordsFound          Int      @default(0)
  recordsNew            Int      @default(0)
  recordsUpdated        Int      @default(0)
  recordsMerged         Int      @default(0)
  errorMessage          String?  @db.Text
  durationMs            Int?
  manual                Boolean  @default(false) // true if triggered manually

  createdAt             DateTime @default(now())

  @@index([runId])
  @@index([sourcePlatform])
  @@index([runAtUtc])
  @@index([parseSuccess])
}

model WholesaleSupplierApproval {
  id                    String   @id @default(cuid())
  supplierId            String
  reviewedBy            String?  // Admin user ID
  reviewedAt            DateTime?
  action                String   @db.VarChar(20) // approved | rejected | merged
  notes                 String?  @db.Text
  mergedIntoSupplierId  String?  @db.VarChar(64) // If duplicate was merged

  createdAt             DateTime @default(now())

  supplier              WholesaleSupplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([reviewedBy])
  @@index([action])
  @@index([createdAt])
}

model WholesaleSupplierBlacklist {
  id                    String   @id @default(cuid())
  type                  String   @db.VarChar(20) // domain | phone | email | instagram_handle | facebook_page
  value                 String   @db.VarChar(500)
  reason                String   @db.Text
  addedBy               String?  // Admin user ID
  addedAt               DateTime @default(now())

  @@unique([type, value])
  @@index([type])
  @@index([addedAt])
}
